(()=>{var n=e=>document.getElementById(e),h=e=>document.querySelectorAll(e),D=()=>Math.round(new Date().getTime()/Math.random()),g=(e,t={},s=[])=>{let i=document.createElement(e);return Object.entries(t).map(([r,l])=>i[r]=l),s.map(r=>i.append(r)),i},p=(e,t)=>t===void 0?JSON.parse(localStorage.getItem(e)):localStorage.setItem(e,JSON.stringify(t)),L=e=>{let t=new Blob([JSON.stringify(e)],{type:"application/json"});return URL.createObjectURL(t)},I=e=>JSON.parse(JSON.stringify(e)),w=e=>e.classList.remove("invisible"),_=e=>e.classList.add("invisible");var k=!1,T=!1;function O(e){switch(e.key){case"z":k&&o.undo();break;case"Z":k&&T&&o.redo();break;case"Control":k=!0;break;case"Shift":T=!0;break}}function $(e){switch(e.key){case"Control":k=!1;break;case"Shift":T=!1;break}}function C(e,t){let s=e.target,i=s.value,r=s.selectionEnd,l=o.items.indexOf(t),c=l-1,b=l+1;switch(e.key){case"Delete":if(r==i.length){let d=o.items[b];t.setName(t.name+d.name),d.delete(),o.focusTo(l,r)}break;case"Backspace":if(r===0&&o.items.length>1){e.preventDefault();let d=o.items[c],E=d?d.name:"";d?(d.name=E+i,o.focusTo(c,E.length)):o.focusTo(l,0),t.delete()}break;case"Enter":let q=i.slice(r),S=l+1;t.name=i.substr(0,r),o.addItem(new a({name:q}),S),o.focusTo(S,0);break;case"ArrowUp":if(!o.items[c])break;e.preventDefault(),o.focusTo(c,r);break;case"ArrowDown":if(!o.items[b])break;e.preventDefault(),o.focusTo(b,r);break}}var m=render=()=>{o.element.innerHTML="",o.items.forEach((e,t)=>{let s=g("input",{type:"checkbox",checked:e.done});s.oninput=l=>e.setDone(l.target.checked),s.onmousedown=drag.started,s.ontouchstart=drag.started;let i=g("input",{type:"text",value:e.name,placeholder:"Untitled"});t==0&&(i.autofocus=!0),i.oninput=l=>e.setName(l.target.value),i.onkeydown=l=>C(l,e);let r=g("li",{id:e.id},[s,i]);o.element.append(r),o.save()})};var x=[],A=()=>{let e=n("import_config");w(e);function t(){x.map(s=>o.items.push(new a(s))),_(e),m()}n("combine").onclick=t,n("replace").onclick=()=>{o.items=[],t()}},J=e=>{var i;let t,s=new FileReader;((i=e.dataTransfer)==null?void 0:i.items)?(e.preventDefault(),t=e.dataTransfer.items[0].getAsFile()):e.dataTransfer?(e.preventDefault(),t=e.dataTransfer.files[0]):t=e.target.files[0],s.onerror=r=>alert("error importing list: "+r),s.onload=function(){x=JSON.parse(this.result),A()},s.readAsText(t)},F=e=>{let t=n("paste_dialogue"),s=t.querySelector("textarea");w(t),n("import_pasted").onclick=()=>{try{x=JSON.parse(s.value)}catch(i){console.log("error importing JSON: importing as plain text"),x=s.value.split(`
`).map(l=>new a({name:l}))}_(t),A()}},G=()=>{let e=n("export");e.href=L(o.items),e.download=`big_list_${new Date().toLocaleDateString()}.json`};var K=250,B=setTimeout(M,K);function M(){G(),p("checklist",o.items);let{states:e,index:t}=o.history;e.length-1==t&&o.makeHistory()}var v=class{constructor(t,s){this.element=t,this.items=s||[],this.history={index:0,states:[I(this.items)]}}initializeItems(t){this.items=t.map(s=>new a(s))}makeHistory(){let{history:t,items:s}=this,{states:i,index:r}=t;i.length-1!=r&&(t.states=i.slice(r),t.index=i.length-1),t.states.length>50&&t.states.splice(0,1),t.states.push(I(s)),t.index++}undo(){let{states:t,index:s}=this.history,i=t[s-1];i&&(this.initializeItems(i),this.history.index=s-1,m())}redo(){let{states:t,index:s}=this.history,i=t[s+1];i&&(this.initializeItems(i),this.history.index=s+1,m())}save(){clearTimeout(B),B=setTimeout(M,K)}focusTo(t,s){setTimeout(()=>{let r=n(this.items[t].id).querySelector('input[type="text"]');r.focus(),r.setSelectionRange(s,s)},10)}addItem(t=new a,s=this.items.length){this.items.splice(s,0,t),m(),this.focusTo(s)}},a=class{constructor(t={}){this.id=D(),this.name=t.name||"",this.done=t.done||!1}setName(t){this.name=t,o.save()}setDone(t){this.done=t,o.save()}delete(){let t=o.items.indexOf(this);o.items.splice(t,1),m()}};var z=n("checklist"),R=p("checklist"),H=R?R.map(e=>new a(e)):[new a],P=new v(z,H),o=P;var u=!1,j,N=0,U=e=>j=setTimeout(()=>u=e,250),f=drag={started(e){U(e.target.closest("li"))},moved(e){requestAnimationFrame(()=>{if(!u)return;document.documentElement.classList.add("noscroll"),N=0;let s=e.touches?e.touches[0].pageY:e.clientY;u.classList.add("drug");for(let i of h("li:not(.drug)")){let r=i.getBoundingClientRect(),c=r.top+r.height/2>s;i.classList.toggle("shift",c),c||(N+=1)}})},ended(){if(u){let e=o.items.find(s=>s.id==u.id),t=o.items.indexOf(e);o.items.splice(t,1),o.items.splice(N,0,e),m(),document.activeElement.focus(),document.activeElement.blur()}clearTimeout(j),document.documentElement.classList.remove("noscroll"),h("li").forEach(e=>e.className=""),u=!1}};function y(e){let t=o.items[o.items.length-1];e.target==o.element&&t.name.length&&o.addItem()}var W=p("theme"),Y=h("[data-theme]"),V=n("import_file"),Z=n("import_paste");document.body.classList.add(W);Y.forEach(e=>e.onclick=()=>{let t=e.getAttribute("data-theme");document.body.className=t,p("theme",t)});onclick=y;ontouchstart=y;onkeydown=O;onkeyup=$;ontouchmove=f.moved;onmousemove=f.moved;ontouchend=f.ended;onmouseup=f.ended;V.oninput=J;Z.onclick=F;onbeforeunload=o.save;m();})();
