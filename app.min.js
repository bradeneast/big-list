(()=>{var n=e=>document.getElementById(e),p=e=>document.querySelectorAll(e),L=()=>Math.round(new Date().getTime()/Math.random()),g=(e,t={},s=[])=>{let i=document.createElement(e);return Object.entries(t).map(([r,l])=>i[r]=l),s.map(r=>i.append(r)),i},u=(e,t)=>t===void 0?JSON.parse(localStorage.getItem(e)):localStorage.setItem(e,JSON.stringify(t)),D=e=>{let t=new Blob([JSON.stringify(e)],{type:"application/json"});return URL.createObjectURL(t)},w=e=>JSON.parse(JSON.stringify(e)),_=e=>e.classList.remove("invisible"),h=e=>e.classList.add("invisible");var x=!1,T=!1;function $(e){switch(e.key){case"z":x&&o.undo();break;case"Z":x&&T&&o.redo();break;case"Control":x=!0;break;case"Shift":T=!0;break}}function O(e){switch(e.key){case"Control":x=!1;break;case"Shift":T=!1;break}}function C(e,t){let s=e.target,i=s.value,r=s.selectionEnd,l=o.items.indexOf(t),c=l-1,b=l+1;switch(e.key){case"Delete":if(r==i.length){let d=o.items[b];t.setName(t.name+d.name),d.delete(),o.focusTo(l,r)}break;case"Backspace":if(r===0&&o.items.length>1){e.preventDefault();let d=o.items[c],S=d?d.name:"";d?(d.name=S+i,o.focusTo(c,S.length)):o.focusTo(l,0),t.delete()}break;case"Enter":let q=i.slice(r),N=l+1;t.name=i.substr(0,r),o.addItem(new a({name:q}),N),o.focusTo(N,0);break;case"ArrowUp":if(!o.items[c])break;e.preventDefault(),o.focusTo(c,r);break;case"ArrowDown":if(!o.items[b])break;e.preventDefault(),o.focusTo(b,r);break}}var m=render=()=>{o.element.innerHTML="",o.items.forEach((e,t)=>{let s=g("input",{type:"checkbox",checked:e.done});s.oninput=l=>e.setDone(l.target.checked),s.onmousedown=drag.started,s.ontouchstart=drag.started;let i=g("input",{type:"text",value:e.name,placeholder:"Untitled"});t==0&&(i.autofocus=!0),i.oninput=l=>e.setName(l.target.value),i.onkeydown=l=>C(l,e);let r=g("li",{id:e.id},[s,i]);o.element.append(r),o.save()})};var y=[],A=()=>{let e=n("import_config");_(e);function t(){y.map(s=>o.items.push(new a(s))),h(e),m()}n("combine").onclick=t,n("replace").onclick=()=>{o.items=[],t()}},J=e=>{var i;let t,s=new FileReader;((i=e.dataTransfer)==null?void 0:i.items)?(e.preventDefault(),t=e.dataTransfer.items[0].getAsFile()):e.dataTransfer?(e.preventDefault(),t=e.dataTransfer.files[0]):t=e.target.files[0],s.onerror=r=>alert("error importing list: "+r),s.onload=function(){y=JSON.parse(this.result),A()},s.readAsText(t)},F=e=>{let t=n("paste_dialogue"),s=t.querySelector("textarea");_(t),n("import_pasted").onclick=()=>{try{y=JSON.parse(s.value)}catch(i){y=s.value.split(`
`).map(r=>new a({name:r}))}h(t),A()}},G=()=>{let e=n("export");e.href=D(o.items),e.download=`big_list_${new Date().toLocaleDateString()}.json`};var K=250,B=setTimeout(M,K);function M(){G(),u("checklist",o.items);let{states:e,index:t}=o.history;e.length-1==t&&o.makeHistory()}var v=class{constructor(t,s){this.element=t,this.items=s||[],this.history={index:0,states:[w(this.items)]}}initializeItems(t){this.items=t.map(s=>new a(s))}makeHistory(){let{history:t,items:s}=this,{states:i,index:r}=t;i.length-1!=r&&(t.states=i.slice(r),t.index=i.length-1),t.states.length>50&&t.states.splice(0,1),t.states.push(w(s)),t.index++}undo(){let{states:t,index:s}=this.history,i=t[s-1];i&&(this.initializeItems(i),this.history.index=s-1,m())}redo(){let{states:t,index:s}=this.history,i=t[s+1];i&&(this.initializeItems(i),this.history.index=s+1,m())}save(){clearTimeout(B),B=setTimeout(M,K)}focusTo(t,s){setTimeout(()=>{let r=n(this.items[t].id).querySelector('input[type="text"]');r.focus(),r.setSelectionRange(s,s)},10)}addItem(t=new a,s=this.items.length){this.items.splice(s,0,t),m(),this.focusTo(s)}},a=class{constructor(t={}){this.id=L(),this.name=t.name||"",this.done=t.done||!1}setName(t){this.name=t,o.save()}setDone(t){this.done=t,o.save()}delete(){let t=o.items.indexOf(this);o.items.splice(t,1),m()}};var z=n("checklist"),R=u("checklist"),H=R?R.map(e=>new a(e)):[new a],P=new v(z,H),o=P;var f=!1,j,E=0,U=e=>j=setTimeout(()=>f=e,250),k=drag={started(e){U(e.target.closest("li"))},moved(e){requestAnimationFrame(()=>{if(!f)return;document.documentElement.classList.add("noscroll"),E=0;let s=e.touches?e.touches[0].pageY:e.clientY;f.classList.add("drug");for(let i of p("li:not(.drug)")){let r=i.getBoundingClientRect(),c=r.top+r.height/2>s;i.classList.toggle("shift",c),c||(E+=1)}})},ended(){if(f){let e=o.items.find(s=>s.id==f.id),t=o.items.indexOf(e);o.items.splice(t,1),o.items.splice(E,0,e),m(),document.activeElement.focus(),document.activeElement.blur()}clearTimeout(j),document.documentElement.classList.remove("noscroll"),p("li").forEach(e=>e.className=""),f=!1}};function I(e){let{target:t}=e;t==o.element&&o.items[o.items.length-1].name.length&&o.addItem(),t.classList.contains("cancel")&&p(".modal").forEach(s=>h(s))}var W=u("theme"),Y=p("[data-theme]"),V=n("import_file"),Z=n("import_paste");document.body.classList.add(W);Y.forEach(e=>e.onclick=()=>{let t=e.getAttribute("data-theme");document.body.className=t,u("theme",t)});onclick=I;ontouchstart=I;onkeydown=$;onkeyup=O;ontouchmove=k.moved;onmousemove=k.moved;ontouchend=k.ended;onmouseup=k.ended;V.oninput=J;Z.onclick=F;onbeforeunload=o.save;m();})();
