(()=>{var l=e=>document.getElementById(e),u=e=>document.querySelectorAll(e),O=()=>Math.round(new Date().getTime()/Math.random()),g=(e,t={},o=[])=>{let s=document.createElement(e);return Object.entries(t).map(([n,r])=>s[n]=r),o.map(n=>s.append(n)),s},p=(e,t)=>t===void 0?JSON.parse(localStorage.getItem(e)):localStorage.setItem(e,JSON.stringify(t)),$=e=>{let t=new Blob([JSON.stringify(e)],{type:"application/json"});return URL.createObjectURL(t)},y=e=>JSON.parse(JSON.stringify(e)),w=e=>e.classList.remove("invisible"),f=e=>e.classList.add("invisible");var x=!1,I=!1,h=!1,C,_=0,U=e=>C=setTimeout(()=>h=e,250);function T(e){U(e.target.closest("li"))}function v(e){requestAnimationFrame(()=>{if(!h)return;document.documentElement.classList.add("noscroll"),_=0;let o=e.touches?e.touches[0].pageY:e.clientY;h.classList.add("drug");for(let s of u("li:not(.drug)")){let n=s.getBoundingClientRect(),m=n.top+n.height/2>o;s.classList.toggle("shift",m),m||(_+=1)}})}function E(){if(h){let e=i.items.find(o=>o.id==h.id),t=i.items.indexOf(e);i.items.splice(t,1),i.items.splice(_,0,e),a(),document.activeElement.focus(),document.activeElement.blur()}clearTimeout(C),document.documentElement.classList.remove("noscroll"),u("li").forEach(e=>e.className=""),h=!1}function A(e){switch(e.key){case"z":x&&i.undo();break;case"Z":x&&I&&i.redo();break;case"Control":x=!0;break;case"Shift":I=!0;break}}function M(e){switch(e.key){case"Control":x=!1;break;case"Shift":I=!1;break}}function J(e,t){let o=e.target,s=o.value,n=o.selectionEnd,r=i.items.indexOf(t),m=r-1,b=r+1;switch(e.key){case"Delete":if(n==s.length){let d=i.items[b];t.setName(t.name+d.name),d.delete(),i.focusTo(r,n)}break;case"Backspace":if(n===0&&i.items.length>1){e.preventDefault();let d=i.items[m],D=d?d.name:"";d?(d.name=D+s,i.focusTo(m,D.length)):i.focusTo(r,0),t.delete()}break;case"Enter":let P=s.slice(n),L=r+1;t.name=s.substr(0,n),i.addItem(new c({name:P,done:t.done}),L),i.focusTo(L,0);break;case"ArrowUp":if(!i.items[m])break;e.preventDefault(),i.focusTo(m,n);break;case"ArrowDown":if(!i.items[b])break;e.preventDefault(),i.focusTo(b,n);break}}function S({target:e}){e.classList.contains("cancel")&&u(".modal").forEach(f)}var a=render=()=>{i.element.innerHTML="",i.items.forEach((e,t)=>{let o=g("input",{type:"checkbox",checked:e.done});o.oninput=r=>e.setDone(r.target.checked),o.onmousedown=T,o.ontouchstart=T,o.onblur=i.trim;let s=g("input",{type:"text",value:e.name,placeholder:"Untitled"});t==0&&(s.autofocus=!0),s.oninput=r=>e.setName(r.target.value),s.onkeydown=r=>J(r,e),s.onblur=i.trim;let n=g("li",{id:e.id},[o,s]);i.element.append(n),i.save()})};var k=[];function F(){let e=l("import_config");w(e);function t(){k.map(o=>i.items.push(new c(o))),f(e),a()}l("combine").onclick=t,l("replace").onclick=()=>{i.items=[],t()}}function K(e){var s;let t,o=new FileReader;((s=e.dataTransfer)==null?void 0:s.items)?(e.preventDefault(),t=e.dataTransfer.items[0].getAsFile()):e.dataTransfer?(e.preventDefault(),t=e.dataTransfer.files[0]):t=e.target.files[0],o.onerror=n=>alert("error importing list: "+n),o.onload=function(){k=JSON.parse(this.result),F()},o.readAsText(t)}function B(e){let t=l("paste_dialogue"),o=t.querySelector("textarea");w(t),l("import_pasted").onclick=()=>{try{k=JSON.parse(o.value)}catch(s){k=o.value.split(`
`).map(n=>new c({name:n}))}f(t),F()}}function R(){let e=l("export");e.href=$(i.items),e.download=`big_list_${new Date().toLocaleDateString()}.json`}var j=250,q=setTimeout(z,j);function z(){R(),p("checklist",i.items);let{states:e,index:t}=i.history;e.length-1==t&&i.makeHistory()}var N=class{constructor(t,o){this.element=t,this.items=o||[],this.history={index:0,states:[y(this.items)]}}initializeItems(t){this.items=t.map(o=>new c(o))}makeHistory(){let{history:t,items:o}=this,{states:s,index:n}=t;s.length-1!=n&&(t.states=s.slice(n),t.index=s.length-1),t.states.length>50&&t.states.splice(0,1),t.states.push(y(o)),t.index++}undo(){let{states:t,index:o}=this.history,s=t[o-1];s&&(this.initializeItems(s),this.history.index=o-1,a())}redo(){let{states:t,index:o}=this.history,s=t[o+1];s&&(this.initializeItems(s),this.history.index=o+1,a())}save(){clearTimeout(q),q=setTimeout(z,j)}focusTo(t,o){setTimeout(()=>{let n=l(this.items[t].id).querySelector('input[type="text"]');n.focus(),n.setSelectionRange(o,o)},10)}addItem(t=new c,o=this.items.length){this.items.splice(o,0,t),a(),this.focusTo(o)}},c=class{constructor(t={}){this.id=O(),this.name=t.name||"",this.done=t.done||!1}setName(t){this.name=t,i.save()}setDone(t){this.done=t,i.save()}delete(){let t=i.items.indexOf(this);i.items.splice(t,1),a()}};var W=l("checklist"),H=p("checklist"),Y=H?H.map(e=>new c(e)):[new c],V=new N(W,Y),i=V;var Z=p("theme"),G=u("[data-theme]"),Q=l("import_file"),X=l("import_paste");document.body.classList.add(Z);G.forEach(e=>e.onclick=()=>{let t=e.getAttribute("data-theme");document.body.className=t,p("theme",t)});onclick=S;ontouchstart=S;onkeydown=A;onkeyup=M;ontouchmove=v;onmousemove=v;ontouchend=E;onmouseup=E;Q.oninput=K;X.onclick=B;onbeforeunload=i.save;a();})();
