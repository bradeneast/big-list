(()=>{var l=e=>document.getElementById(e),h=e=>document.querySelectorAll(e),D=()=>Math.round(new Date().getTime()/Math.random()),g=(e,t={},s=[])=>{let i=document.createElement(e);return Object.entries(t).map(([r,n])=>i[r]=n),s.map(r=>i.append(r)),i},p=(e,t)=>t===void 0?JSON.parse(localStorage.getItem(e)):localStorage.setItem(e,JSON.stringify(t)),E=e=>{let t=new Blob([JSON.stringify(e)],{type:"application/json"});return URL.createObjectURL(t)},w=e=>JSON.parse(JSON.stringify(e)),I=e=>e.classList.remove("invisible"),b=e=>e.classList.add("invisible");var x=!1,_=!1;function L(e){switch(e.key){case"z":x&&o.undo();break;case"Z":x&&_&&o.redo();break;case"Control":x=!0;break;case"Shift":_=!0;break}}function O(e){switch(e.key){case"Control":x=!1;break;case"Shift":_=!1;break}}function $(e,t){let s=e.target,i=s.value,r=s.selectionEnd,n=o.items.indexOf(t),c=n-1,y=n+1;switch(e.key){case"Delete":if(r==i.length){let d=o.items[y];t.setName(t.name+d.name),d.delete(),o.focusTo(n,r)}break;case"Backspace":if(r===0&&o.items.length>1){e.preventDefault();let d=o.items[c],S=d?d.name:"";d?(d.name=S+i,o.focusTo(c,S.length)):o.focusTo(n,0),t.delete()}break;case"Enter":let j=i.slice(r),N=n+1;t.name=i.substr(0,r),o.addItem(new a({name:j}),N),o.focusTo(N,0);break;case"ArrowUp":if(!o.items[c])break;e.preventDefault(),o.focusTo(c,r);break;case"ArrowDown":if(!o.items[y])break;e.preventDefault(),o.focusTo(y,r);break}}var m=render=()=>{o.element.innerHTML="",o.items.forEach((e,t)=>{let s=g("input",{type:"checkbox",checked:e.done});s.oninput=n=>e.setDone(n.target.checked),s.onmousedown=drag.started,s.ontouchstart=drag.started;let i=g("input",{type:"text",value:e.name,placeholder:"Untitled"});t==0&&(i.autofocus=!0),i.oninput=n=>e.setName(n.target.value),i.onkeydown=n=>$(n,e);let r=g("li",{id:e.id},[s,i]);o.element.append(r),o.save()})};var A=250,J=setTimeout(C,A);function C(){let e=l("export");e.href=E(o),e.download=`big_list_${new Date().toLocaleDateString()}.json`,p("checklist",o.items);let{states:t,index:s}=o.history;t.length-1==s&&o.makeHistory()}var T=class{constructor(t,s){this.element=t,this.items=s||[],this.history={index:0,states:[w(this.items)]}}initializeItems(t){this.items=t.map(s=>new a(s))}makeHistory(){let{history:t,items:s}=this,{states:i,index:r}=t;i.length-1!=r&&(t.states=i.slice(r),t.index=i.length-1),t.states.length>50&&t.states.splice(0,1),t.states.push(w(s)),t.index++}undo(){let{states:t,index:s}=this.history,i=t[s-1];i&&(this.initializeItems(i),this.history.index=s-1,m())}redo(){let{states:t,index:s}=this.history,i=t[s+1];i&&(this.initializeItems(i),this.history.index=s+1,m())}save(){clearTimeout(J),J=setTimeout(C,A)}focusTo(t,s){setTimeout(()=>{let r=l(this.items[t].id).querySelector('input[type="text"]');r.focus(),r.setSelectionRange(s,s)},10)}addItem(t=new a,s=this.items.length){this.items.splice(s,0,t),m(),this.focusTo(s)}},a=class{constructor(t={}){this.id=D(),this.name=t.name||"",this.done=t.done||!1}setName(t){this.name=t,o.save()}setDone(t){this.done=t,o.save()}delete(){let t=o.items.indexOf(this);o.items.splice(t,1),m()}};var q=l("checklist"),F=p("checklist"),z=F?F.map(e=>new a(e)):[new a],G=new T(q,z),o=G;var u=!1,K,v=0,H=e=>K=setTimeout(()=>u=e,250),f=drag={started(e){H(e.target.closest("li"))},moved(e){requestAnimationFrame(()=>{if(!u)return;document.documentElement.classList.add("noscroll"),v=0;let s=e.touches?e.touches[0].pageY:e.clientY;u.classList.add("drug");for(let i of h("li:not(.drug)")){let r=i.getBoundingClientRect(),c=r.top+r.height/2>s;i.classList.toggle("shift",c),c||(v+=1)}})},ended(){if(u){let e=o.items.find(s=>s.id==u.id),t=o.items.indexOf(e);o.items.splice(t,1),o.items.splice(v,0,e),m()}clearTimeout(K),document.documentElement.classList.remove("noscroll"),h("li").forEach(e=>e.className=""),u=!1}};var k=[],B=()=>{let e=l("import_config");I(e);function t(){k.map(s=>o.items.push(new a(s))),b(e),m()}l("combine").onclick=t,l("replace").onclick=()=>{o.items=[],t()}},M=e=>{var i;let t,s=new FileReader;((i=e.dataTransfer)==null?void 0:i.items)?(e.preventDefault(),t=e.dataTransfer.items[0].getAsFile()):e.dataTransfer?(e.preventDefault(),t=e.dataTransfer.files[0]):t=e.target.files[0],s.onerror=r=>alert("error importing list: "+r),s.onload=function(){k=JSON.parse(this.result).items,B()},s.readAsText(t)},R=e=>{let t=l("paste_dialogue"),s=t.querySelector("textarea");I(t),l("import_pasted").onclick=()=>{try{k=JSON.parse(s.value).items}catch(i){console.log("error importing JSON: importing as plain text"),k=s.value.split(`
`).map(n=>new a({name:n}))}b(t),B()}};var P=p("theme"),U=h("[data-theme]"),W=l("import_file"),Y=l("import_paste");document.body.classList.add(P);U.forEach(e=>e.onclick=()=>{let t=e.getAttribute("data-theme");document.body.className=t,p("theme",t)});onkeydown=L;onkeyup=O;ontouchmove=f.moved;onmousemove=f.moved;ontouchend=f.ended;onmouseup=f.ended;W.oninput=M;Y.onclick=R;onbeforeunload=o.save;m();})();
